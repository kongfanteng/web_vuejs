# Vue 源码

## 1

### 1.1 defineAsyncComponent.test.[packages/runtime-core/src/defineAsyncComponent.ts](../../public/example/1.vue3.base/packages/runtime-core/src/defineAsyncComponent.ts)

```ts
import { ref } from '@vue/reactivity'
import { Fragment } from './createVNode'
import { h } from './h'
import { isFunction } from '@vue/shared'

export function defineAsyncComponent(options) {
  if (isFunction(options)) {
    options.loader = options
  }
  return {
    setup() {
      const { loader } = options
      let Comp = null
      const loaded = ref(false)
      const error = ref(false)
      const loading = ref(false)
      if (options.timeout) {
        setTimeout(() => {
          error.value = true // 时间过期失败
        }, options.timeout)
      }
      if (options.delay) {
        setTimeout(() => {
          loading.value = true // 延迟加载
        }, options.delay)
      }

      function load() {
        return loader()
          .then((c) => {
            Comp = c?.default ? c.default : c
            loaded.value = true
          })
          .catch((err) => {
            if (options.onError) {
              return new Promise((resolve, reject) => {
                const retry = () => resolve(load())
                const fail = () => reject(err)
                options.onError(err, retry, fail)
              })
            }
            error.value = true
          })
      }
      load()

      return () => {
        if (loaded.value) {
          return h(Comp)
        } else if (error.value && options.errorComponent) {
          return h(options.errorComponent)
        } else if (loading.value && options.loadingComponent) {
          return h(options.loadingComponent)
        }
        return h(Fragment, [])
      }
    },
  }
}
```

### 1.2 .[xx](../../public/example/1.vue3.base/xx)

```js

```

### 1.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 1.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 1.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 2

### 2.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 2.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 2.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 2.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 2.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 3

### 3.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 3.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 4

### 4.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 4.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 5

### 5.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 5.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.5 [xx](../../public/example/1.vue3.base/xx)

```js

```
