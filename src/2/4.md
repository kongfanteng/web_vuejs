# Vue 源码

## 1 piniaApi

### 1.1 piniaApi.P(1061~1093).[README.md](../../public/example/1.vue3.base/README.md)

```md
<!-- ... -->

## piniaApi

- createPinia
- defineStore
- scope 最外层状态，作用域；
- scope.stop 停止更新；
- id+options
- options = {id: xx}
- id+setup
- 无，缓存 store
- option -> setup
- $set
```

### 1.2 piniaApi.[src/App.vue](../../public/example/1.vue3.base/src/App.vue)

```vue
<script setup>
import { useCounterStore } from './stores/counter'
import { useTodoStore } from './stores/todo'
import { storeToRefs } from 'pinia'
const store = useCounterStore()

function patch() {
  store.$patch((state) => {
    // setState()
    state.count += 100
    state.count += 200
  })
}

// const currentTodo = ref('')
// const todoStore = useTodoStore()
const { increment, decrement } = store

// setupApi 导出的不能解构，需要转换成 ref 在使用；reactive({ref()}) 拆包；
const todoStore = useTodoStore()
const { todos, todo, todoLen } = storeToRefs(todoStore) // reactive(); 仅能转对象;
const { addTodo } = todoStore // 函数不转
// todoStore.$dispose() // 停止 store 中 effect
</script>

<template>
  {{ store.count }}
  ( {{ store.double }} )
  <button @click="increment">+</button>
  <button @click="decrement">-</button>
  <button @click="store.$reset()">重置</button>
  <button @click="patch">patch</button>

  <input type="text" v-model="todo" />
  <li v-for="t of todos">
    {{ t }}
  </li>
  <button @click="addTodo()">添加{{ todoLen }}</button>
</template>
```

### 1.3 piniaApi.[src/main.js](../../public/example/1.vue3.base/src/main.js)

```js
import { createApp, watch } from 'vue'
import App from './App.vue'
import { createPinia } from './pinia'

const app = createApp(App)
const pinia = createPinia()

function plugin({ store, id }) {
  // if (id === 'counter') {
  //   watch(
  //     () => store.count,
  //     function (newVal) {
  //       console.log('newVal:', newVal)
  //     }
  //   )
  // }
  let state = JSON.parse(localStorage.getItem(id))
  if (state) {
    store.$state = state
  }
  store.$subscribe((state, id) => {
    localStorage.setItem(id, JSON.stringify(state))
  })
}
pinia.use(plugin)

app.use(pinia)

app.mount('#app')
```

### 1.4 piniaApi.[src/pinia/createPinia.js](../../public/example/1.vue3.base/src/pinia/createPinia.js)

```js
import { effectScope, ref } from 'vue'
import { piniaSymbol } from './rootStore'

export function createPinia() {
  const scope = effectScope()
  // 整个应用的状态稍后 defineStore 的时候，就会在这里增加状态
  const state = scope.run(() => ref({}))
  const _p = []
  // vue3 中能用 map 全部用的 map
  const pinia = {
    install(app) {
      // 所有组件都可以通过 inject 来访问，只能在 setup 中访问；
      app.provide(piniaSymbol, pinia)
      // 所有组件都可以通过 this 来访问到 pinia
      app.config.globalProperties.$pinia = pinia
    },
    use(plugin) {
      // 注入插件...，自定义插件
      _p.push(plugin)
      return pinia
    },
    _p,
    state, // counter -> store.state; todo -> store.state;
    _e: scope,
    _s: new Map(), // 记录有哪些 store 的
    // counter -> store
  }
  return pinia
}

// 暂停更新 effectScope
// state.counter.computed
// state.stop()

// state.counter -> store
// state.todo -> store
```

### 1.5 piniaApi.[src/pinia/store.js](../../public/example/1.vue3.base/src/pinia/store.js)

```js
import {
  computed,
  effectScope,
  getCurrentInstance,
  inject,
  isRef,
  reactive,
  toRefs,
  watch,
} from 'vue'
import { piniaSymbol } from './rootStore'

function isComputed(o) {
  return !!(isRef(o) && o.effect)
}

// 对于 pinia 而言，修改状态有三种方式 1. state.xxx ''; 2. store.action(); 3. store.$patch;
// ...
function createSetupStore(id, setup, pinia) {
  const store = reactive({
    $patch(partialStateOrMutator) {
      // 部分状态和全部状态左一个合并即可
      if (typeof partialStateOrMutator === 'function') {
        partialStateOrMutator(pinia.state.value[id])
      } else {
        merge(pinia.state.value[id], partialStateOrMutator)
      }
    },
    $subscribe(callback) {
      scope.run(() =>
        watch(pinia.state.value[id], (state) => {
          callback(state, id)
        })
      )
    },
    $dispose() {
      scope.stop() // 放弃这个 store
      pinia._s.delete(id) // 删除映射关系
    },
  }) // store
  let scope

  function wrapAction(action) {
    return function () {
      let result = action.call(store, ...arguments)
      // todo...
      return result
    }
  }
  const setupStore = pinia._e.run(() => {
    // 划分父子作用域
    scope = effectScope()
    return scope.run(() => setup())
  })

  let isSetupStore = false
  if (!pinia.state.value[id]) {
    isSetupStore = true
    pinia.state.value[id] = {} // vue3 无 state 则增加一个空对象
  }
  for (const key in setupStore) {
    const v = setupStore[key]
    if (typeof v === 'function') {
      setupStore[key] = wrapAction(v)
    } else if (isSetupStore && !isComputed(v)) {
      // 只有 setupStore 才需要将其他属性赋值
      // 除了函数的都作为 state 放入
      pinia.state.value[id][key] = v
    }
  }

  Object.assign(store, setupStore)
  Object.defineProperty(store, '$state', {
    get() {
      return pinia.state.value[id]
    },
    set: (newState) => {
      console.log('newState:', newState)
      store.$patch(newState)
    },
  })
  // 调用插件，并且将当前的 store 传递给插件。用户可以自己监控 store 中的变化；
  pinia._p.forEach((plugin) => scope.run(() => plugin({ store, id })))
  pinia._s.set(id, store) // store -> reactive({ count: 0 })

  // 为了后续方便，我们将这个初始化的流程放到一个函数里
  return store
}
```

## 2 piniaApi.pinia-presist

### 2.1 piniaApi.test.[src/stores/todo.js](../../public/example/1.vue3.base/src/stores/todo.js)

```ts
import { computed, ref } from 'vue'
import { defineStore } from '../pinia'

export const useTodoStore = defineStore('todo', () => {
  // setup 方法
  const todo = ref('')
  const todos = ref([])
  const todoLen = computed(() => todos.value.length)
  function addTodo() {
    todos.value.push(todo.value)
  }
  return {
    todo,
    todos,
    addTodo,
    todoLen,
  }
})
// export const useTodoStore = defineStore('todo', {
//   state: () => {
//     return {
//       todos: [],
//     }
//   },
//   actions: {
//     addTodo(todo) {
//       this.todos.push(todo)
//     },
//   },
// })
```

### 2.2 pinia-presist.P(1094~1098).[package.json](../../public/example/1.vue3.base/package.json)

```json
{
  "name": "2.pinia-project",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "pinia": "^2.1.7",
    "pinia-plugin-persistedstate": "^3.2.1",
    "vue": "^3.4.19"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.0.4",
    "vite": "^5.1.4"
  }
}
```

### 2.3 pinia-presist.[src/main.js](../../public/example/1.vue3.base/src/main.js)

```js
import { createApp, watch } from 'vue'
import App from './App.vue'
import { createPinia } from 'pinia'
import piniaPluginPersistedState from 'pinia-plugin-persistedstate'
// pnpm i pinia-plugin-persistedstate

const app = createApp(App)
const pinia = createPinia()

pinia.use(piniaPluginPersistedState)

app.use(pinia)

app.mount('#app')
```

### 2.4 pinia-presist.[src/stores/counter.js](../../public/example/1.vue3.base/src/stores/counter.js)

```js
import { defineStore } from 'pinia'
export const useCounterStore = defineStore('counter', {
  // ...
  persist: true,
})
```

### 2.5 pinia-presist.test.[src/stores/todo.js](../../public/example/1.vue3.base/src/stores/todo.js)

```js
import { computed, ref } from 'vue'
import { defineStore } from 'pinia'

export const useTodoStore = defineStore(
  'todo',
  () => {
    // ...
  },
  { persist: true }
)
```

## 3

### 3.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 3.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 4

### 4.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 4.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 5

### 5.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 5.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.5 [xx](../../public/example/1.vue3.base/xx)

```js

```
