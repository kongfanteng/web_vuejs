# Vue 源码

## 1 [246~](https://www.processon.com/mindmap/63ac109f6592974cd49ff115)

### 1.1 源码逻辑.effect.[example/5.effect.html](../../public/example/1.vue3.base/example/5.effect.html)

```html
<script type="module">
  import { reactive, effect } from './vue.runtime.esm-bundler.js'
  // 1. 已经是 effect 函数，再被 effect
  let reactiveEffect = effect(() => {
    console.log(1)
  })
  // debugger
  let reactiveEffect2 = effect(reactiveEffect)
  console.log(reactiveEffect === reactiveEffect2) // false
</script>
```

### 1.2 源码逻辑.effect.[example/5.effect.html](../../public/example/1.vue3.base/example/5.effect.html)

```html
<script type="module">
  import { reactive, effect, ref } from './vue.runtime.esm-bundler.js'
  const state = reactive({ name: 'jw' })
  // 2）effect 死循环问题，儿子effect调用父亲effect；
  /*
      const state = reactive({ a: 1 })
      effect(function () {
        // e0
        console.log(state.a)
        effect(() => {
          // e1
          console.log(1)
          effect(() => {
            // e2
            console.log(2)
            state.a = Math.random()
            // debugger
            // this.run() // e2 -> e0；进入死循环
          })
        })
      })
      */

  // 3）调试 track 和 effect
  /*
      effect(() => {
        state.name
      })
      debugger
      state.name = 'jiang'
      */

  // 4）调试 scheduler 函数
  /*
      effect(
        () => {
          state.name
        },
        {
          scheduler: (effect) => {
            console.log('更新')
          },
        }
      )
      debugger
      state.name = 'jiang'
      */

  // 5）clean 清理操作
  effect(() => {
    console.log('rerender')
    if (state.name === 'jw') {
      console.log(state.age)
    }
  })
  state.age = 100 // 更新
  state.name = 'jiang' // 不要更新
  state.age = 200 // 不更新，位运算，不是全部清理，采用位运算来计算
</script>
```

### 1.3 proxyRefs.[packages/reactivity/dist/5.ref.html](../../public/example/1.vue3.base/packages/reactivity/dist/5.ref.html)

```html
<div id="app"></div>
<script type="module">
  import { reactive, toRefs, proxyRefs, watchEffect } from './reactivity.js'
  // import { watchEffect } from '/node_modules/@vue/runtime-dom/dist/runtime-dom.esm-browser.js'
  // '/node_modules/@vue/reactivity/dist/reactivity.esm-browser.js' './reactivity.js' '/node_modules/@vue/runtime-dom/dist/runtime-dom.esm-browser.js'
  const state1 = reactive({ name: 'jw' })
  const state2 = reactive({ age: 30 })
  // proxyRefs 后续模板编译用到，渲染时会用到
  const r = proxyRefs({ ...toRefs(state1), ...toRefs(state2) })
  watchEffect(() => {
    app.innerHTML = r.name + r.age
  })
  setTimeout(() => {
    r.name = 'kft'
  }, 1000)
</script>
```

### 1.4 proxyRefs.[packages/reactivity/src/ref.ts](../../public/example/1.vue3.base/packages/reactivity/src/ref.ts)

```ts
class RefImpl {
  _value
  __v_isRef = true
  dep = new Set()
  constructor(public rawValue) {
    this._value = toReactive(rawValue)
  }
  // 内部采用类的属性访问器 -> Object.defineProperty
  get value() {
    if (activeEffect) {
      trackEffects(this.dep)
    }
    return this._value
  }
  set value(newVal) {
    if (newVal !== this.rawValue) {
      this.rawValue = newVal
      this._value = toReactive(newVal)
      triggerEffects(this.dep)
    }
  }
}

class ObjectRefImpl {
  __v_isRef = true
  constructor(public object, public key) {}
  get value() {
    return this.object[this.key]
  }
  set value(val) {
    this.object[this.key] = val
  }
}

export function proxyRefs(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      let r = Reflect.get(target, key, receiver)
      return r.__v_isRef ? r.value : r
    },
    set(target, key, value, receiver) {
      const oldValue = target[key]
      if (oldValue.__v_isRef) {
        oldValue.value = value
        return true
      } else {
        return Reflect.set(target, key, value, receiver)
      }
    },
  })
}
```

### 1.5 proxyRefs.[packages/reactivity/src/computed.ts](../../public/example/1.vue3.base/packages/reactivity/src/computed.ts)

```js
class ComputedRefImpl {
  // ...
  dep = new Set()
  __v_isRef = true
  // ...
}
```

## 2

### 2.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 2.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 2.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 2.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 2.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 3

### 3.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 3.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 3.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 4

### 4.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 4.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 4.5 [xx](../../public/example/1.vue3.base/xx)

```js

```

## 5

### 5.1 [xx](../../public/example/1.vue3.base/xx)

```ts

```

### 5.2 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.3 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.4 [xx](../../public/example/1.vue3.base/xx)

```js

```

### 5.5 [xx](../../public/example/1.vue3.base/xx)

```js

```
